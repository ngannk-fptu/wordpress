The Uncanny Automator – Easy Automation, Integration, Webhooks & Workflow Builder Plugin for WordPress is vulnerable to Privilege Escalation in all versions up to, and including, 6.3.0.2. This is due to add_role() and user_role() functions missing proper capability checks performed through the validate_rest_call() function. This makes it possible for unauthenticated attackers to set the role of arbitrary users to administrator granting full access to the site, though privilege escalation requires an active account on the site so this is considered an authenticated privilege escalation.


```python
public function add_role( $user_id, $action_data, $recipe_id, $args ) {

		$role = $action_data['meta'][ $this->action_meta ];

		$user_obj = new WP_User( (int) $user_id );
		if ( $user_obj instanceof WP_User ) {
			$user_obj->add_role( $role );

			// Hydrate the tokens with value.
			$this->hydrate_tokens(
				array(
					'USER_ROLES' => ! empty( $user_obj->roles ) ? implode( ', ', array_values( $user_obj->roles ) ) : '',
				)
			);

			Automator()->complete->user->action( $user_id, $action_data, $recipe_id );
		}
	}
```

hàm **user_role** cho phép người dùng thêm role phụ cho user (vẫn giữ role cũ): 

```
$user_obj->add_role( $role );
```

```
public function user_role( $user_id, $action_data, $recipe_id, $args ) {
 
    $role = $action_data['meta'][ $this->action_meta ];
 
    $user_obj = new WP_User( (int) $user_id );
 
    $user_roles = $user_obj->roles;
 
    if ( ! in_array( 'administrator', $user_roles, true ) ) {
 
        $user_obj->set_role( $role );
        // Hydrate the tokens with value.
        $this->hydrate_tokens(
            array(
                'USER_ROLES' => ! empty( $user_obj->roles ) ? implode( ', ', array_values( $user_obj->roles ) ) : '',
            )
        );
 
        Automator()->complete->action( $user_id, $action_data, $recipe_id );
 
    } else {
 
        $error_message = esc_attr__( 'For security, the change role action cannot be applied to administrators.', 'uncanny-automator' );
 
        $action_data['complete_with_errors'] = true;
 
        Automator()->complete->action( $user_id, $action_data, $recipe_id, $error_message );
 
    }
}
```

Hàm user_role() thay thế vai trò cũ bằng vai trò mới **($role)**, miễn là user chưa phải admin.

```
if ( ! in_array( 'administrator', $user_roles, true ) ) {
    $user_obj->set_role( $role );
}
```
